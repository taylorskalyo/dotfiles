# -----------------
# Functions
# ------------------------------------------------------------------------------ 
# Exit a codeguard teamocil session cleanly
cgtmux-exit() {
	tmux send-keys -t vim ":q" C-m
	tmux send-keys -t console "exit" C-m
	tmux send-keys -t log C-c
	tmux send-keys -t server C-c
	tmux kill-session -t codeguard
}

# Create parallel ssh connections
sshX() {
  csshX --login deploy --ssh_args "-i /Users/taylor/code/codeguard/config/deploy/keys/deploy -o StrictHostKeyChecking=no" $@
}

# Log in to the codeguard prod database
cg-mysql() {
  host=$(ruby -ryaml -e "data = YAML::load_file('config/database.yml'); puts data['production']['host']")
  user=$(ruby -ryaml -e "data = YAML::load_file('config/database.yml'); puts data['base']['username']")
  database=$(ruby -ryaml -e "data = YAML::load_file('config/database.yml'); puts data['production']['database']")
  pass=$(ruby -ryaml -e "data = YAML::load_file('config/database.yml'); puts data['production']['password']")
  mysql -h$host -u$user -p$pass $database
}

# Open new terminal windows and run the cg teamocil scripts
cg-init() {
  osascript -e 'activate application "iTerm"'
  osascript -e 'tell application "System Events" to keystroke "n" using command down'
  osascript -e 'tell application "iTerm" to tell session -1 of current terminal to write text "tmux; teamocil cg-watch"'
  osascript -e 'tell application "System Events" to keystroke "n" using command down'
  osascript -e 'tell application "iTerm" to tell session -1 of current terminal to write text "tmux; teamocil cg-do"'
  osascript -e 'tell application "System Events" to keystroke "n" using command down'
  osascript -e 'tell application "iTerm" to tell session -1 of current terminal to write text "tmux; teamocil cg-web"'
}

# -----------------
# Aliases
# ------------------------------------------------------------------------------ 
# Turn on/off mysql logging
alias log_mysql="mysql -uroot -p -e \"SET GLOBAL general_log = 'ON';\""
alias nolog_mysql="mysql -uroot -p -e \"SET GLOBAL general_log = 'OFF';\""

# Authorize the current IP address and revoke any past IP addresses
alias ssh-here="aws-auth-ip.rb --authorize --revoke-all --remember --ignore-ip-ranges '98.251.91.62/32'"
